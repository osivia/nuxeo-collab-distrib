<?xml version="1.0"?>
<component name="acrennes-ldap-config">

  <implementation class="org.nuxeo.ecm.directory.ldap.LDAPDirectoryDescriptor" />
  <implementation class="org.nuxeo.ecm.directory.ldap.LDAPServerDescriptor" />
  <require>org.nuxeo.ecm.directory.ldap.LDAPDirectoryFactory</require>
  <require>org.nuxeo.ecm.directory.sql.storage</require>

  <extension target="org.nuxeo.ecm.directory.ldap.LDAPDirectoryFactory"
    point="servers">

    <server name="default">

      <ldapUrl>${nuxeo.ldap.url}</ldapUrl>
      <bindDn>${nuxeo.ldap.binddn}</bindDn>
      <bindPassword>${nuxeo.ldap.bindpassword}</bindPassword>
      <retries>${nuxeo.ldap.retries}</retries>
    </server>

  </extension>

  <extension target="org.nuxeo.ecm.directory.ldap.LDAPDirectoryFactory"
    point="directories">

    <directory name="userLdapDirectory">
      <server>default</server>
      <schema>user</schema>
      <idField>username</idField>
      <passwordField>password</passwordField>

      <searchBaseDn>${nuxeo.ldap.user.searchBaseDn}</searchBaseDn>
      <searchClass>${nuxeo.ldap.user.searchClass}</searchClass>

      <searchScope>${nuxeo.ldap.user.searchScope}</searchScope>
      <substringMatchType>${nuxeo.ldap.user.searchBehavior}</substringMatchType>
      <readOnly>${nuxeo.ldap.user.readonly}</readOnly>

      <cacheEntryName>acrennes-ldap-user-entry-cache</cacheEntryName>
      <cacheEntryWithoutReferencesName>acrennes-ldap-user-entry-cache-without-references</cacheEntryWithoutReferencesName>

      <missingIdFieldCase>lower</missingIdFieldCase>

      <querySizeLimit>${nuxeo.ldap.query.sizeLimit}</querySizeLimit>
      <queryTimeLimit>${nuxeo.ldap.query.timeLimit}</queryTimeLimit>

      <rdnAttribute>${nuxeo.ldap.user.mapping.rdn}</rdnAttribute>
      <fieldMapping name="username">${nuxeo.ldap.user.mapping.username}</fieldMapping>
      <fieldMapping name="password">${nuxeo.ldap.user.mapping.password}</fieldMapping>
      <fieldMapping name="firstName">${nuxeo.ldap.user.mapping.firstname}</fieldMapping>
      <fieldMapping name="lastName">${nuxeo.ldap.user.mapping.lastname}</fieldMapping>
      <fieldMapping name="company">${nuxeo.ldap.user.mapping.company}</fieldMapping>
      <fieldMapping name="email">${nuxeo.ldap.user.mapping.email}</fieldMapping>

      <references>
	  <ldapReference field="groups" 
	                         directory="groupLdapDirectory"
                         forceDnConsistencyCheck="false"
                         staticAttributeId="ENTPersonProfils"/>
      </references>

    </directory>

    <directory name="groupLdapDirectory">

      <!-- Reuse the default server configuration defined for ldapUserDirectory -->
      <server>default</server>

      <schema>group</schema>
      <idField>groupname</idField>
      <rdnAttribute>${nuxeo.ldap.group.mapping.rdn}</rdnAttribute>

      <searchBaseDn>${nuxeo.ldap.group.searchBaseDn}</searchBaseDn>
      <searchClass>${nuxeo.ldap.group.searchClass}</searchClass>

      <searchScope>${nuxeo.ldap.group.searchScope}</searchScope>
      <substringMatchType>${nuxeo.ldap.group.searchBehavior}</substringMatchType>

      <readOnly>${nuxeo.ldap.group.readonly}</readOnly>

      <cacheEntryName>acrennes-ldap-group-entry-cache</cacheEntryName>
      <cacheEntryWithoutReferencesName>acrennes-ldap-group-entry-cache-without-references</cacheEntryWithoutReferencesName>

      <querySizeLimit>${nuxeo.ldap.query.sizeLimit}</querySizeLimit>
      <queryTimeLimit>${nuxeo.ldap.query.timeLimit}</queryTimeLimit>

      <fieldMapping name="groupname">${nuxeo.ldap.group.mapping.name}</fieldMapping>
      <fieldMapping name="grouplabel">${nuxeo.ldap.group.mapping.label}</fieldMapping>
      <fieldMapping name="description">${nuxeo.ldap.group.mapping.description}</fieldMapping>
      <fieldMapping name="members">${nuxeo.ldap.group.mapping.members.staticAttributeId}</fieldMapping>
      <fieldMapping name="subGroups">${nuxeo.ldap.group.mapping.subGroups}</fieldMapping>

      <references>
        <ldapReference field="members" directory="userLdapDirectory"
                       forceDnConsistencyCheck="false" 
                       staticAttributeId="member" />
        <ldapReference field="subGroups" directory="groupLdapDirectory"
                       forceDnConsistencyCheck="false"  
                       staticAttributeId="subGroups"/>
        <ldapReference field="parentGroups" directory="groupLdapDirectory" 
                       forceDnConsistencyCheck="false"  
                       staticAttributeId="parentGroups"/>
      </references>

    </directory>

  </extension>

</component>